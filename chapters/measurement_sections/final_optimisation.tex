The last two Sections introduced the selection to suppress photons originating in non-\mbox{$\BtoXsgamma$} decays, particularly from \piz and $\eta$ decays (\Cref{sec:photon_selection}),
and the strategy to suppress \mbox{\epem\ra\qqbar} events that were the dominant component in the selected data set (\Cref{sec:continuum_suppression}).
Although a preselection was already developed to prepare an adequate training sample for the \BDT, a more optimal (`tighter') selection is desired to ensure the optimal efficiency and purity of the selected sample.
This Section describes the approach taken to find such optimal selection and calculate the efficiency loss for all applied selections.

\subsection{Simultaneous selection optimisation}\label{sec:simultaneous_optimisation}

After the pre-selection that prepared the data for training a \BDT in \Cref{tab:preselections}, a more robust strategy for tighter selections is developed.
In particular, \BDT output, \piVeto, \etaVeto and \ZMVA may be interconnected in the sense that applying the selection on one of them influences a selection on the others. 
To find an optimal selection point, each threshold is optimised in an iteration-based approach. 
At each step, one variable threshold is optimised to a value that gives the best figure-of-merit score,
while keeping the other requirements unvaried.
Then, this is repeated for other variables.
Each individual optimisation is equivalent to that shown in \Cref{fig:selection_optimisations} and uses figure-of-merit $\mathtt{FOM}_2$, defined in \Cref{eq:punzi_fom}.

In order to maximise the efficiency of the optimisation on correctly reconstructed events without adhering to a more strict definition at this stage, 
this procedure is performed on one randomly selected peaking tag-$B$ candidate per event ($\Mbc >5.27~\gevcc$) combined with the highest energy photon.
The starting point for each selection corresponds to the values in \Cref{tab:preselections}.
The starting $\mathtt{BDT~output}$ selection is chosen at 0.5. 
The \BtoXsgamma admixture of charged and neutral modes is used.
The \epem\ra\qqbar and generic \BB background events from \feiBp and \feiBz modes are merged.
This aims to reproduce `realistic' data conditions, where different background efficiencies may be observed due to different behaviours of \feiBp and \feiBz modes.

After performing the optimisation for each selection, the optimisation steps are repeated 9 more times.
The selections converge and do not vary after round 3 of optimisation.
The converged values are shown in \Cref{tab:interative_optimisation}.

\begin{table}[htbp!]
    \centering
    \caption{\label{tab:interative_optimisation} Optimal selections chosen for this analysis, based on the iterative approach described in \Cref{sec:simultaneous_optimisation}.
    The values for $\mathtt{BDT~output}$ and \ZMVA are chosen near those that are found optimal.
    For \piVeto and \etaVeto the choice is made based on the availability of data-simulation agreement studies performed at Belle II.
    At the time of preparing the analysis, 
    only studies with \piVeto and \etaVeto thresholds 
    up to 0.4 were performed (see \Cref{sec:piz_eta_calibration}).
    }
    \input{tables/iterative_optimisation.tex}
\end{table}

For \piVeto and \etaVeto, the found selection is relatively tight, if inspecting \Cref{fig:bp_piveto,fig:bz_piveto,fig:bp_etaveto,fig:bz_etaveto}.
Furthermore, at the time of preparation of the analysis described, studies regarding the \piVeto and \etaVeto applicability to such tight selections were not available.
Therefore, it was decided to not tighten this selection further than the pre-selection value obtained in \Cref{tab:preselections}.
Repeating the study while keeping \piVeto and \etaVeto selection at 0.4 yields compatible results to those shown in \Cref{tab:interative_optimisation}.
Other selections are retained based on the optimal value from the initial 10 iterations.

\subsection{Summary and efficiency of all analysis selections}\label{sec:selection_summary}

\Cref{tab:cutflow} summarises all the selections and \BDT training results from \Cref{sec:photon_selection,sec:continuum_suppression,sec:final_optimisation},
and lists the final \BtoXsgamma candidate retention.
The retention, in this case, is defined as:
\begin{equation}\label{eq:loose_efficiency}
    r_{\mathrm{cand}} = \frac{N_{\BtoXsgamma}~\mathrm{candidates~after~cut}}{N_{\BtoXsgamma}~\mathrm{no~cut}},
\end{equation}
which is an approximation as it may include multiple tag-$B$ candidates.
In the table, the $\Mbc>5.27~\gevcc$ requirement is no longer applied and all tag-$B$ meson candidates are kept (i.e. high energy photon candidates may contribute more than once per event).

\begin{table}[htbp!]
    \centering
    \caption{\label{tab:cutflow} The summary table of all selections and their retentions, based on \Cref{eq:loose_efficiency}.
    The selections listed here are applied on official Belle II \feiBp and \feiBz samples, described in \Cref{sec:reconstruction_overview}.
    The columns show efficiency for \BtoXsgamma events, calculated on signal \MC, continuum and \BB events, both of which are calculated on generic \MC.
    It can be seen that continuum events are suppressed by roughly two orders of magnitude, whereas generic-\BB decays by more than an order of magnitude.
    }
    \input{tables/cutflow_btosgamma.tex}
\end{table}

\Cref{tab:cutflow} shows that the background suppression procedure roughly halves the number of available \BtoXsgamma events in the sample.
However, the background candidates from \mbox{$\epem\ra\qqbar$} processes are reduced 200 times: to less than 0.5\% of the original value.
Furthermore, generic-\BB event contribution is estimated at 7\% of the original, which means more that an order of magnitude suppression is achieved.
The photon energy spectrum, after these selections have been applied is shown in \Cref{fig:spectrum_after_optimisation}.
Compared with the previous versions of this Figure, e.g.\Cref{fig:spectrum_after_reco}, a much better signal-to-background ratio is visible.

\begin{figure}[htbp!]
    \centering
    \subcaptionbox{\label{fig:spectrum_after_optimisation_bp}}{
        \includegraphics[width=0.45\textwidth]{figures/final_optimisation/Bp_tagged_background_optimal.pdf}
    }    
    \subcaptionbox{\label{fig:spectrum_after_optimisation_bz}}{
        \includegraphics[width=0.45\textwidth]{figures/final_optimisation/Bz_tagged_background_optimal.pdf}
    }    
    \caption{\label{fig:spectrum_after_optimisation}
    \BtoXsgamma spectrum in generic \MC after event reconstruction in \feiBp and \feiBz modes with optimal background suppression selections listed in \Cref{tab:cutflow}.
    Overlaid are events from signal \MC where the photon comes from \BtoXsgamma, multiplied by a scaling factor, with the same selections applied.
    These figures may include a high energy photon combined with multiple tag-$B$ entries per event and can be compared directly with \Cref{fig:spectrum_after_reco} where it is seen that
    the signal-to-background ratio for \BtoXsgamma is 100 times higher.}
\end{figure}
